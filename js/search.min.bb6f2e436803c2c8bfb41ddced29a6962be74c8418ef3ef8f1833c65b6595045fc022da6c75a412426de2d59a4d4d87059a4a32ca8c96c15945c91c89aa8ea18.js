let searchData=[],isSearchInitialized=!1;const searchConfig={resultLimit:20};function simpleMatch(e,t){if(!e||!t)return{matched:!1};const s=e.toLowerCase(),o=t.toLowerCase(),n=s.indexOf(o);return n!==-1?{matched:!0,index:n,length:t.length}:{matched:!1}}function highlightKeyword(e,t){if(!e||!t||t.trim()==="")return e;const n=simpleMatch(e,t);if(!n.matched)return e;const s=e.substring(0,n.index),o=e.substring(n.index,n.index+n.length),i=e.substring(n.index+n.length);return`${s}<span class="bg-yellow-200 text-gray-900 dark:bg-amber-500 dark:text-gray-900 font-medium px-0.5 rounded">${o}</span>${i}`}function createHighlightedExcerpt(e,t){if(!e||!t)return"";const n=simpleMatch(e,t);if(!n.matched)return e.length>150?e.substring(0,150)+"...":e;let s=Math.max(0,n.index-60),o=Math.min(e.length,n.index+n.length+60),i=(s>0?"...":"")+e.substring(s,o);return o<e.length&&(i+="..."),highlightKeyword(i,t)}async function fetchSearchData(){try{const e=await fetch("/index.json");if(e.ok){const n=await e.json();searchData=n.map((e,t)=>({id:t,title:e.title||"",content:e.content||e.summary||"",summary:e.description||e.summary||"",permalink:e.permalink||e.url||"",date:e.date||""})),isSearchInitialized=!0;const t=document.getElementById("init-status");t&&t.classList.add("hidden");return}}catch{}try{const e=await scanPageForArticleLinks();if(e.length===0){searchData=[{id:0,title:"示例文章",permalink:"/posts/example/",date:"2023-01-01",summary:"这是一篇示例文章，用于在找不到实际内容时展示",content:"当搜索系统无法找到实际的文章内容时，会显示这篇示例文章。这可能是因为您的站点还没有任何文章，或者搜索系统无法索引您的内容。"}],isSearchInitialized=!0;return}let n=0;e.forEach(({href:e,title:t})=>{let o="";const s=e.match(/\/(\d{4})\/(\d{2})\/(\d{2})\//);s&&(o=`${s[1]}-${s[2]}-${s[3]}`);const i={id:n++,title:t,permalink:e,date:o,summary:`查看"${t}"的详细内容`,content:t};searchData.push(i)}),isSearchInitialized=!0;const t=document.getElementById("init-status");t&&t.classList.add("hidden")}catch{createFallbackSearchData()}}async function scanPageForArticleLinks(){if(window.location.pathname.includes("/search/"))try{const e=await fetch("/");if(e.ok){const n=await e.text(),t=document.createElement("div");return t.innerHTML=n,extractArticleLinks(t)}}catch{}return extractArticleLinks(document)}function extractArticleLinks(e){const n=["posts","post","blog","article","articles"],t=[];return e.querySelectorAll("a").forEach(e=>{const s=e.getAttribute("href");if(s&&typeof s=="string"&&s.startsWith("/")&&!s.includes("#")){const o=n.some(e=>s.includes(`/${e}/`))||/\/\d{4}\/\d{2}\//.test(s)||s.split("/").length>=3&&!s.endsWith("/");o&&t.push({href:s,title:e.textContent.trim()||s.split("/").pop().replace(/-/g," ")})}}),t}function createFallbackSearchData(){searchData=[{id:0,title:"搜索系统遇到问题",permalink:"/",date:"",summary:"搜索系统无法加载索引数据",content:"搜索系统遇到问题，无法加载索引数据。这可能是临时性问题，请尝试刷新页面或稍后再试。"}],isSearchInitialized=!0;const e=document.getElementById("init-status");e&&(e.innerHTML=`
      <div class="flex items-center text-yellow-600 dark:text-yellow-400">
        <iconify-icon icon="mdi:alert-circle" class="mr-2" width="20" height="20"></iconify-icon>
        <span>搜索使用了备用数据，可能无法找到所有内容</span>
      </div>
    `)}function performSearch(e){if(!isSearchInitialized)return[];if(!e||e.trim()==="")return[];e=e.trim();const t=searchData.filter(t=>{const n=simpleMatch(t.title,e),s=simpleMatch(t.content,e),o=simpleMatch(t.summary,e);return n.matched?(t.score=3,t.titleHighlighted=highlightKeyword(t.title,e)):t.titleHighlighted=t.title,o.matched?(t.score=t.score||2,t.summaryHighlighted=highlightKeyword(t.summary,e)):t.summaryHighlighted=t.summary,s.matched?(t.score=t.score||1,t.contentHighlighted=createHighlightedExcerpt(t.content,e)):t.contentHighlighted=t.content&&t.content.length>150?t.content.substring(0,150)+"...":t.content,t.searchQuery=e,n.matched||s.matched||o.matched});return t.sort((e,t)=>t.score-e.score),t.slice(0,searchConfig.resultLimit)}function renderResults(e){const t=document.getElementById("search-results"),n=document.getElementById("no-results"),s=document.getElementById("loading");if(!t||!n)return;s&&s.classList.add("hidden"),t.innerHTML="",e.length===0?(t.classList.add("hidden"),n.classList.remove("hidden")):(t.classList.remove("hidden"),n.classList.add("hidden"),e.forEach(e=>{const n=document.createElement("article");n.className="bg-white dark:bg-gray-800 rounded-lg shadow-sm p-6 mb-4 hover:shadow-md transition-shadow duration-300";const s=e.date?`
        <div class="flex items-center text-sm text-gray-500 dark:text-gray-400 mb-4">
          <span class="flex items-center">
            <iconify-icon icon="mdi:calendar" class="mr-1" width="16" height="16"></iconify-icon>
            ${e.date}
          </span>
        </div>
      `:"",o=e.titleHighlighted||e.title,i=e.contentHighlighted||e.summaryHighlighted||e.summary||e.content||"";n.innerHTML=`
        <h2 class="text-xl font-bold mb-2">
          <a href="${e.permalink}" class="text-gray-900 dark:text-white hover:text-primary dark:hover:text-primary transition-colors duration-200">
            ${o}
          </a>
        </h2>
        ${s}
        <div class="text-gray-700 dark:text-gray-300 mb-4 bg-gray-50 dark:bg-gray-700/50 p-4 rounded-lg border-l-4 border-blue-500 dark:border-blue-600">
          ${i}
        </div>
        <a href="${e.permalink}" class="inline-flex items-center bg-gradient-to-r from-blue-500 to-indigo-600 text-white px-4 py-2 rounded-lg hover:shadow-md transition-all duration-300">
          阅读全文
          <iconify-icon icon="mdi:arrow-right" class="ml-1" width="16" height="16"></iconify-icon>
        </a>
      `,t.appendChild(n)}))}async function initSearch(){try{await fetchSearchData();const t=document.getElementById("search-input"),s=document.getElementById("search-button"),e=document.getElementById("loading");if(!t||!s)return;s.addEventListener("click",()=>{const n=t.value.trim();n&&(e&&e.classList.remove("hidden"),setTimeout(()=>{const e=performSearch(n);renderResults(e)},300))}),t.addEventListener("keydown",n=>{if(n.key==="Enter"){const n=t.value.trim();n&&(e&&e.classList.remove("hidden"),setTimeout(()=>{const e=performSearch(n);renderResults(e)},300))}});const o=new URLSearchParams(window.location.search),n=o.get("q");n&&(t.value=n,e&&e.classList.remove("hidden"),setTimeout(()=>{const e=performSearch(n);renderResults(e)},500))}catch(t){const e=document.getElementById("init-status");e&&(e.innerHTML=`
        <div class="flex items-center text-red-600">
          <iconify-icon icon="mdi:alert" class="mr-2" width="20" height="20"></iconify-icon>
          <span>搜索初始化失败：${t.message}</span>
        </div>
      `)}}document.readyState==="loading"?document.addEventListener("DOMContentLoaded",initSearch):initSearch()